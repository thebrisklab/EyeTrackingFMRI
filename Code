### 1.1 fMRIprocess function to get the fRMI xii_pmean. The output should be v by t, (v: brain region, t: time points)


fMRI_xii_pmean <- function(xii = xii, parcellation = "Schaefer_100", num = 100) {
  # load the parcellation
  parc <- load_parc(parcellation)
  # convert parc to a vector, indicating which of the brain parcellation region each fMRI voxel belongs to (left/right cortex)
  parc_vec <- c(as.matrix(parc))
  # put NA in medial wall vertices to make the number of rows the same with Schaefer parcellation
  xii.new <- move_from_mwall(xii, NA) 
  # matrix (voxel by time) of cortex + sub_cortex
  xii_mat <- as.matrix(xii.new)  # 96854 by 311
  # read the labels of fMRI subcortex (31870)
  parc2 <- xii.new$meta$subcort$labels
  # transfer all the labels to character type and add regions vectors and labels vectors together
  parc_all = c(as.character(parc_vec), as.character(parc2))
  # create the required length vector with L/R cortex and 19 subcortex labels
  label = c(as.character(1:num), levels(parc2)[3:21])
  # prepare for the matrix for storing the fMRI signal values later
  xii_pmean <- matrix(nrow = num + 19, ncol = ncol(xii_mat))
  #################################################################
  # first extract the matrix (x * 311) for each parcellation region
  # Second, for each time point, get the mean of the columns which is the average value of all voxel within this parcellation
  for (p in label) {
    # extract the rows that meet the "p" which are categorized to the same label
    data_p <- xii_mat[parc_all == p,]
    # calculate the mean for each time point, i.e., the mean fMRI signal for the region
    xii_pmean[which(label == p), ] <- colMeans(data_p, na.rm = TRUE)
}
  return(xii_pmean)
}
